import { SocketDriver } from './socket.driver';
export class SocketConnections {
  private static connections = {};
  static getHandler(url, token: { id: any, userId: any }) {
    if (!SocketConnections.connections[url]) {
      console.log('Trying to make connection with: ', url);
      
      let config = {
          log: false,
          secure: false,
          forceWebsockets: true,
      };

      SocketConnections.connections[url] = SocketDriver.connect(url, config);
      SocketConnections.connections[url].on('connect', () => {
        console.log('Connected to %s', url);
        SocketConnections.connections[url].emit('authentication', token);
        SocketConnections.connections[url].on('unauthorized', res => console.error('Unauthenticated', res));
        setInterval(() => SocketConnections.connections[url].emit('lb-ping'), 15000);
        SocketConnections.connections[url].on('lb-pong', data => console.info('Heartbeat: ', data));
        SocketConnections.connections[url].on('disconnect', data => {
            console.info('Unexpected disconnection from IO - Trying to reconnect');
            SocketConnections.connections[url] = SocketDriver.connect(url, config);
        });
      });
    } else {
      console.log('Reusing existing connection: ', url);
    }
    return SocketConnections.connections[url];
  }
}